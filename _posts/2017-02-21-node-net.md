---
layout: page
title: Node.js源码解析--net.js模块
categories: [Node.js]
tags: [net.js,socket]
---

net.js模块是Node.js异步网络中最重要的一部分。 相信大多数读者都使用过net.js模块。

## 前言
那net.js模块它底层到底做了什么，让我们有异步网络的能力。反过来问就是说：net.js底层通过什么来实现异步网络。

这篇文章并不会告诉你如何的使用net.js模块。我希望通过这篇文章告诉你，net.js模块是如何实现这个异步网络。


## 1. 背景知识
我们知道Node.js的大部分能力都是由它的c/c++模块提供的，net.js模块也不例外。

那么net.js关键的知识就是:

1. TCP传输控制协议
2. Socket套接字编程

### 1.1 TCP
提供的是面向连接、可靠的字节流服务。当客户和服务器彼此交换数据前，必须先在双方之间建立一个TCP连接，之后才能传输数据。
TCP提供超时重发，丢弃重复数据，检验数据，流量控制等功能，保证数据能从一端传另一端.

### 1.2 Socket
像TCP/IP、TCP和UDP等协议只有一套，而我们系统多个TCP连接或多个应用程序进程必须通过同一个 TCP协议端口传输数据。
为了区别不同的应用程序进程和连接，许多计算机操作系统为应用程序与TCP/IP协议交互提供了称为套接字(Socket)的接口。

套接字就是支持TCP/IP网络通信的基本操作单元，是我们进行TCP/IP进行通信的接口。

## 2.从创建一个TCP服务器说起
我们可以很轻松的创建一个TCP服务器和客户端。

创建一个 TCP 服务器:

```js
//server.js
const net = require('net');
var server = net.createServer((socket)=>{
  socket.on('data', (data) => {
    console.log('client send message: ' , data.toString());
  });
  socket.write('hello client!');
});
server.listen(8888,'127.0.0.1' , ()=>{
  console.log(server.address());
});
```

应答服务器的客户端:

```js
//client.js
const net = require('net');
var client = net.connect({port: 8888, host: '127.0.0.1'}, function() {
    client.write('hello server!\r\n');
});
client.on('data', (data) => {
  console.log('server send message: ' ,data.toString());
  client.end();
});
client.on('end', () => {
  console.log('disconnected from server');
});
```

使用`cmd`分别启动TCP服务器和客户端，这样就可以与服务器通讯了。

```sh
node server.js
node client.js
```

一次最简单的通讯：


1. TCP服务器端依次调用Socket()、bind()、listen()之后，就会监听指定的socket地址了。 
2. TCP客户端依次调用Socket()、connect()之后就向TCP服务器发送了一个连接请求。 
3. TCP服务器监听到这个请求之后，就会调用accept()函数去接收请求，这样连接就建立好了。之后就可以开始网络I/O操作了，即类同于普通文件的读写I/O操作。

### 3 TCP服务器端
首先TCP服务器端会创建一个socket；然后bind系统调用把addr中的地址分配给与描述符socket关联的未命名套接字，地址结构的长度由addr_len指定，
通过socket调用创建的套接字必须经过命名（绑定地址）后才能使用；然后调用listen()来监听这个socket。

![TCP]({{site.baseurl}}/images/2017/0221_01.jpg)

从图中可以清晰的看出，服务器端与客户端的区别在于，服务器端监听端口等待连接请求，而客户端则是请求连接。

回到net.js模块是如何实现这个TCP服务器的创建的呢。

首当其冲的就是

### 3.1 net.Server对象
看上面的TCP服务器创建代码，你可能会以为`net.createServer()`函数调用之后就会创建一个socket实例对象。
其实不是的，`net.createServer()`只是用来初始化参数的，包含连接成功后的回调函数。

```js
//net.js
function Server(options, connectionListener) {
  EventEmitter.call(this);
  this.on('connection', connectionListener);
  this._handle = null;
  this._usingSlaves = false;
  this._slaves = [];
  this._unref = false;
  this.allowHalfOpen = options.allowHalfOpen || false;
  this.pauseOnConnect = !!options.pauseOnConnect;
}
```
`Server`对象，最主要的参数是`_handle`，这个参数保存着服务器的socket。
那么何时才创建socket呢。答案在`listen`函数。

> 与net.createServer相同

### 3.2 Server.prototype.listen原型方法
整个socket的创建是从这里开始的，