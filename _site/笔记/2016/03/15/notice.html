<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
	<meta charset="UTF-8">
<meta name="apple-mobile-web-app-title" content="2015年度小知识点和技巧笔记">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-touch-fullscreen" content="yes">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="format-detection" content="email=no">
<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
<link rel="stylesheet" href="/blog/stylesheets/normalize.css">
<link rel="stylesheet" href="/blog/stylesheets/base.css">
<link rel="stylesheet" href="/blog/stylesheets/monokai.css">
<script src="/blog/javascripts/base.js"></script>
<title>2015年度小知识点和技巧笔记</title>
</head>
<body>
	<div class="j-container-fluid j-header">
	<div class="j-row">
		<div class="j-container">
			<h1 class="j-logo"><a href="/blog/"><img src="/blog/images/logo.png" /> </a></h1>
			<nav class="j-row j-nav">
				<a href="/blog/">首页</a>
				<a href="/blog/list.html">归档</a>
				<a href="https://github.com/Yi-love">Github</a>
				<a href="/blog/me.html">Me</a>
			</nav>
		</div>
	</div>
</div>
	<div class="j-container">
		<div class="j-row">
			<div class="j-col-xs-12 j-col-sm-12 j-col-md-9">
				<div class="j-container j-content">
					<h2 class="j-i-title"><a href="javascript:void(0)" title="2015年度小知识点和技巧笔记">2015年度小知识点和技巧笔记</a></h2>
						<p class="j-i-time">15 Mar 2016</p>
						<p class="j-i-tags">
							
							<span class="j-i-tag">2015</span>
							
							<span class="j-i-tag">技巧</span>
							
							<span class="j-i-tag">个人</span>
							
							<span class="j-i-tag">前端</span>
							
						</p>
						<div class="j-container">
							<div class="j-row j-artclie-txt"><blockquote>
  <p>2015年虽然已经过去3个半月，但是想了又想还是觉得有必要把这篇笔记写一下。知识点比较多，就不按时间来咯。</p>
</blockquote>

<blockquote>
  <h3 id="section">1. 随机取色</h3>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="k">return</span> <span class="s1">'#'</span><span class="o">+</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mh">0xffffff</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span></code></pre></figure>

<blockquote>
  <h5 id="section-1">扩展</h5>
  <p>字符串解析模版</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="p">[].</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">$$</span><span class="p">(</span><span class="s2">"*"</span><span class="p">),</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">outline</span><span class="o">=</span><span class="s2">"1px solid #"</span><span class="o">+</span><span class="p">(</span><span class="o">~~</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">))).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
  <span class="p">});</span></code></pre></figure>

<blockquote>
  <h3 id="histrorypushstate-">2.histrory.pushState 无刷新修改地址栏显示地址的方法</h3>
  <p>需求：Ajax局部刷新是小菜一碟。但现在每次ajax请求后，在不刷新页面的情况下改变url地址。</p>
</blockquote>

<blockquote>
  <h5 id="section-2">限制</h5>
  <p>1.传递的url必须域名相同，不能跨域
2.state对象虽然可以存储很多自定义的属性，但对于不可序列化的对象则不能存储，如：DOM对象。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="kd">var</span> <span class="nx">stateObj</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">};</span>
  <span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">,</span> <span class="s2">"page 2"</span><span class="p">,</span> <span class="s2">"list.html"</span><span class="p">);</span></code></pre></figure>

<blockquote>
  <p>比如我现在的页面的url是：http://yi-love.github.io/blog/,我的目标是要让点击Github之后：https://github.com/Yi-love，
然后点击返回回退到 ： http://yi-love.github.io/blog/list.html 这个页面。</p>
</blockquote>

<blockquote>
  <p>所以通过ajax我们可以每次都pushState一个json对象。这样就会让用户点击回退的时候可以回退到他之前查询过的页面，而不是一个新的页面。</p>
</blockquote>

<blockquote>
  <h5 id="section-3">其它相关连参数</h5>
</blockquote>

<blockquote>
  <p>1.history.replaceState: 操作类似于history.pushState()，不同之处在于replaceState()方法会修改当前历史记录条目而并非创建新的条目。</p>
</blockquote>

<blockquote>
  <p>2.window.onpopstate: 是popstate事件在window对象上的事件句柄.每当处于激活状态的历史记录条目发生变化时,popstate事件就会在对应window对象上触发.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">();</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">onpopstate</span> <span class="o">=</span> <span class="nx">funcg</span><span class="p">;</span></code></pre></figure>

<blockquote>
  <h5 id="section-4">参考资料</h5>
  <p><a href="https://developer.mozilla.org/zh-CN/docs/DOM/Manipulating_the_browser_history">histrory.pushState</a></p>
</blockquote>

<blockquote>
  <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/onpopstate">window.onpopstate</a></p>
</blockquote>

<blockquote>
  <h3 id="promise">3.Promise图片预加载</h3>
  <p>思想：通过Promise异步加载图片。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
  <span class="s1">'use strict'</span><span class="p">;</span>
  <span class="c1">//主要的加载器Promise</span>
  <span class="kd">function</span> <span class="nx">defer</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">,</span> 
      <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resolve</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">reject</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">resolve</span><span class="p">:</span> <span class="nx">resolve</span><span class="p">,</span><span class="c1">//成功</span>
      <span class="na">reject</span><span class="p">:</span> <span class="nx">reject</span><span class="p">,</span><span class="c1">//失败</span>
      <span class="na">promise</span><span class="p">:</span> <span class="nx">promise</span><span class="c1">//promise对象</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="cm">/**
   * 图片预加载 ImagePreloader
   */</span>
  <span class="kd">var</span> <span class="nx">ImagePreloader</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parallel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parallel</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**
   * 图片加载队列
   */</span>
  <span class="nx">ImagePreloader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">queue</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">array</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">array</span> <span class="o">=</span> <span class="p">[</span><span class="nx">array</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">defer</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="na">collection</span><span class="p">:</span> <span class="nx">array</span><span class="p">,</span>
      <span class="na">deferred</span><span class="p">:</span> <span class="nx">deferred</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**
   * 处理加载成功和失败的图片 preloadImage
   */</span>
  <span class="nx">ImagePreloader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">preloadImage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
      <span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">resolve</span><span class="p">;</span>
      <span class="nx">image</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">resolve</span><span class="p">;</span>
      <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="cm">/**
   * 加载图片
   */</span>
  <span class="nx">ImagePreloader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">preload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deck</span><span class="p">,</span> <span class="nx">decks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parallel</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">item</span><span class="p">.</span><span class="nx">collection</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">item</span><span class="p">.</span><span class="nx">collection</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">preloadImage</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">collection</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">item</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">preloadImage</span><span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">deck</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span><span class="c1">//请求图片</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">deferred</span><span class="p">))</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
      <span class="nx">decks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">deck</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">decks</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">global</span><span class="p">.</span><span class="nx">ImagePreloader</span> <span class="o">=</span> <span class="nx">ImagePreloader</span><span class="p">;</span>
<span class="p">}(</span><span class="nb">window</span><span class="p">));</span></code></pre></figure>

<blockquote>
  <p>例子：</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">Deck</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">preloader</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'data-images'</span><span class="p">));</span>
    <span class="nx">preloader</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Deck '</span> <span class="o">+</span> <span class="nx">index</span> <span class="o">+</span> <span class="s1">' loaded.'</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">'loaded'</span><span class="p">);</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMContentLoaded'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">ip</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImagePreloader</span><span class="p">({</span>
	  <span class="na">parallel</span><span class="p">:</span> <span class="kc">false</span>
	<span class="p">});</span>
	<span class="kd">var</span> <span class="nx">decks</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'.deck'</span><span class="p">));</span>
	<span class="nx">decks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">deck</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">new</span> <span class="nx">Deck</span><span class="p">(</span><span class="nx">deck</span><span class="p">,</span> <span class="nx">ip</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
	<span class="p">});</span>
	<span class="nx">ip</span><span class="p">.</span><span class="nx">preload</span><span class="p">()</span>
	 <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
	  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'All decks loaded.'</span><span class="p">);</span>
	<span class="p">});</span>
  <span class="p">});</span></code></pre></figure>

<blockquote>
  <h3 id="section-5">4.页面性能测试</h3>
  <p><a href="http://www.webpagetest.org/">http://www.webpagetest.org/</a></p>
</blockquote>

</div>
						</div>
				</div>
			</div>
			<div class="j-col-xs-12 j-col-sm-12 j-col-md-3">
	<div class="j-user">
		<div class="j-user-thumb">
			<a href=""><img src="/blog/images/user.jpg" alt="" /></a>
		</div>
		<div class="j-user-info">
			<a href="">微信</a>
			<a href="">微博</a>
			<a href="">QQ</a>
		</div>
	</div>
	<div class="j-class-list">
		<h3 class="j-row">分类</h3>
		
		<a href="/blog/category.html?category=笔记">笔记 <span class="j-class-i-num">(9)</span></a>
		
		<a href="/blog/category.html?category=JavaScript">JavaScript <span class="j-class-i-num">(7)</span></a>
		
		<a href="/blog/category.html?category=bee.js">bee.js <span class="j-class-i-num">(1)</span></a>
		
	</div>
</div>
		</div>
	</div>
	<div class="j-container-fluid j-footer">
	<div class="j-container">
		<p class="j-footer-say">喜欢一个人需要理由吗？需要吗？不需要吗？需要吗？……</p>
		<p class="j-footer-say j-tlgr">——周星驰 《大话西游》</p>
	</div>
</div>

</body>
</html>