<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
	<meta charset="UTF-8">
<meta name="apple-mobile-web-app-title" content="zepto.js.v1.0 源码解读-ajax.js-02">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-touch-fullscreen" content="yes">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="format-detection" content="email=no">
<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
<link rel="stylesheet" href="/blog/stylesheets/normalize.css">
<link rel="stylesheet" href="/blog/stylesheets/base.css">
<link rel="stylesheet" href="/blog/stylesheets/monokai.css">
<script src="/blog/javascripts/base.js"></script>
<title>zepto.js.v1.0 源码解读-ajax.js-02</title>
</head>
<body>
	<div class="j-container-fluid j-header">
	<div class="j-row">
		<div class="j-container">
			<h1 class="j-logo"><a href="/blog/"><img src="/blog/images/logo.png" /> </a></h1>
			<nav class="j-row j-nav">
				<a href="/blog/">首页</a>
				<a href="/blog/list.html">归档</a>
				<a href="https://github.com/Yi-love">Github</a>
				<a href="/blog/me.html">Me</a>
			</nav>
		</div>
	</div>
</div>
	<div class="j-container">
		<div class="j-row">
			<div class="j-col-xs-12 j-col-sm-12 j-col-md-9">
				<div class="j-container j-content">
					<h2 class="j-i-title"><a href="javascript:void(0)" title="zepto.js.v1.0 源码解读-ajax.js-02">zepto.js.v1.0 源码解读-ajax.js-02</a></h2>
						<p class="j-i-time">12 Nov 2015</p>
						<p class="j-i-tags">
							
							<span class="j-i-tag">前端开发</span>
							
							<span class="j-i-tag">zepto</span>
							
							<span class="j-i-tag">源码</span>
							
							<span class="j-i-tag">ajax</span>
							
						</p>
						<div class="j-container">
							<div class="j-row j-artclie-txt"><blockquote>
  <p>第一篇zepto源码我已经对zepto的核心选择器分析了一番，这一篇主要的解读一下ajax模块。看zepto是怎么实现ajax这个基本的模块的。
我们知道不管是zepto还是jquery都可以通过下面的方式获取到服务器的数据或者向服务器发送数据。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="na">type</span><span class="p">:</span><span class="s2">"post"</span><span class="p">,</span><span class="c1">//get</span>
    <span class="na">url</span><span class="p">:</span><span class="s2">"/ajax"</span><span class="p">,</span>
    <span class="na">async</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
    <span class="na">data</span> <span class="p">:</span> <span class="p">{</span><span class="na">ajax</span><span class="p">:</span><span class="kc">true</span><span class="p">},</span>
    <span class="na">success</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span></code></pre></figure>

<blockquote>
  <p>这里我也写了一段很简单的js模拟ajax功能。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">ajax</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">()</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">async</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'POST'</span><span class="p">)</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"Content-type"</span><span class="p">,</span><span class="s2">"application/x-www-form-urlencoded"</span><span class="p">)</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span> <span class="o">||</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">304</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span> <span class="p">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">data</span> <span class="p">:</span> <span class="kc">null</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="na">type</span><span class="p">:</span><span class="s2">"post"</span><span class="p">,</span><span class="c1">//get</span>
    <span class="na">url</span><span class="p">:</span><span class="s2">"/ajax"</span><span class="p">,</span>
    <span class="na">async</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
    <span class="na">data</span> <span class="p">:</span> <span class="s1">'ajax=true'</span><span class="p">,</span>
    <span class="na">success</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span></code></pre></figure>

<blockquote>
  <p>上面的这段代码是不完善的，要真正的使用的话必须进行加工，也就是处理各种有可能出现的情况。</p>
</blockquote>

<blockquote>
  <h4 id="ajax">ajax核心处理问题列表</h4>
  <p>下图是zepto.js的ajax模块的核心模块的问题处理列表。
<img src="/blog/images/2015/1112_01.jpg" alt="$.ajax" /></p>
</blockquote>

<blockquote>
  <p>最初写这篇文章是11/12号，可是到了今天11/14号我才有继续写下去的勇气。开始我觉得ajax请求可能没什么难的，自己也经常使用过。
但当自己真正去看zepto的ajax核心源码的时候才知道，自己所了解的只是那么多知识中的冰山一角。就一个$.Deferred()函数就花了我一个上午，
而且只是知道了它是如何使用，要如何写一个Deferred模块我真的一点头绪的没有，deferred模块 zepto也是有的。它到底是一个什么东西，它的
作用是什么先卖个关子。有兴趣的可以点击以下链接去了解一下：</p>
</blockquote>

<blockquote>
  <p><a href="http://www.csdn.net/article/2014-05-28/2819979-JavaScript-Promise">http://www.csdn.net/article/2014-05-28/2819979-JavaScript-Promise</a></p>
</blockquote>

<blockquote>
  <p><a href="http://www.html5rocks.com/en/tutorials/es6/promises/">http://www.html5rocks.com/en/tutorials/es6/promises/</a></p>
</blockquote>

<blockquote>
  <p><a href="http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html">http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html</a></p>
</blockquote>

<blockquote>
  <p>说叉了。回归正题，ajax这个模块该怎么去讲这也是个问题。我本来就是个话比较少的人， 我喜欢想象，思考。用很多东西我知道是怎么回事但就是找不到以一种什么方式
表达出来。我不想把ajax代码加上注释后以这种方式展现出来去引导大家去读懂ajax。我相信每个人脑子里都想很多为什么，很想知道为什么。</p>
</blockquote>

<blockquote>
  <p>我也是，所以我就是来解决为什么的。上面就是我罗列的18个为什么。</p>
</blockquote>

<h4 id="section">1.源码展示</h4>
<blockquote>
  <p>我很不想罗列代码但是没办法，我不可能凭空说吧。还是来看代码吧。看完了就继续说咯。
<img src="/blog/images/2015/1112_02.jpg" alt="$.ajax" />
<img src="/blog/images/2015/1112_03.jpg" alt="$.ajax" />
<img src="/blog/images/2015/1112_04.jpg" alt="$.ajax" />
<img src="/blog/images/2015/1112_05.jpg" alt="$.ajax" /></p>
</blockquote>

<blockquote>
  <h4 id="section-1">1. 合并参数</h4>
  <p>合并参数大家都看得懂，extend 是继承的意思.函数传人2个参数，意思就是第1个参数继承第2个参数,这里因为 第1个参数为空，所以等价于:</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js"> 	<span class="c1">//合并参数</span>
 	<span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{});</span>
	<span class="c1">//等价于</span>
	<span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">options</span> <span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> 
			<span class="nx">settings</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
	<span class="p">}</span>
	<span class="c1">//特例</span>
	<span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span><span class="c1">//没有 options[name] !== undefined</span>
	
	<span class="c1">//合并默认设置和用户的设置</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">)</span> 
    	<span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> 
    		<span class="nx">settings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></code></pre></figure>

<blockquote>
  <p>$.extend源码在此，有红箭头的说明是在这里所执行的：
<img src="/blog/images/2015/1112_06.jpg" alt="$.ajax" /></p>
</blockquote>

<blockquote>
  <p>特例可能说的不是很恰当，因为settings 和 options应该不是同一对象，settings是options的拷贝。</p>
</blockquote>

<h4 id="ajaxstart">2. 试图添加一个全局的事件 ajaxStart</h4>
<blockquote>
  <p>当global: true时。在Ajax请求生命周期内，如果没有其他Ajax请求当前活跃将会被触发。
<img src="/blog/images/2015/1112_07.jpg" alt="$.ajax" /></p>
</blockquote>

<h4 id="section-2">3.判断请求是否跨域</h4>
<blockquote>
  <p>判断是否跨域，只要比较一下当前协议和域名，是否与传人的协议和域名是否匹配即可。但这里要对一下ie做兼容.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="c1">//当前url</span>
    <span class="nx">originAnchor</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span>
    <span class="nx">originAnchor</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span>
    <span class="c1">//ajax请求url</span>
    <span class="nx">urlAnchor</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span>
    <span class="nx">urlAnchor</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">url</span>
    <span class="c1">// ie兼容</span>
    <span class="nx">urlAnchor</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">urlAnchor</span><span class="p">.</span><span class="nx">href</span> <span class="c1">//获取ajax请求的url</span>
    <span class="c1">//判断ajax请求是否跨域</span>
    <span class="nx">settings</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="o">=</span> <span class="p">(</span><span class="nx">originAnchor</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">'//'</span> <span class="o">+</span> <span class="nx">originAnchor</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> 
                        <span class="o">!==</span> <span class="p">(</span><span class="nx">urlAnchor</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">'//'</span> <span class="o">+</span> <span class="nx">urlAnchor</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span></code></pre></figure>

<blockquote>
  <p>ie可能会出现urlAnchor.href = ‘‘的问题，所以加上 urlAnchor.href = urlAnchor.href防止出错。
有兴趣的可以看一下下面这篇文章。
<a href="https://github.com/madrobby/zepto/pull/1049">https://github.com/madrobby/zepto/pull/1049</a></p>
</blockquote>

<blockquote>
  <h4 id="url">4.url合法化</h4>
  <p>$.ajax对应url进行了2次的判断，第一次判断是否为空，是则使用当前页面url，否则不修改。
第2次进行锚点删除，即删除 url‘#’后面的字符，只保留前半部分。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span><span class="c1">//为空</span>
        <span class="nx">setting</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="c1">//截取'#'前半部分</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">hashIndex</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">setting</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">hashIndex</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></code></pre></figure>

<blockquote>
  <h4 id="section-3">5.序列化数据</h4>
  <p>我觉得还是先来看看  $.ajaxSettings 的基本参数吧。不然一头雾水呵呵，下面列举的参数不是全部只是一部分，有的可以用户自己传人。
最后的时候我会列举出全部的属性.看看zepto.ajax可以设置多少参数。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSettings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">//请求类型</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="c1">// 发送请求前执行的函数 , 默认 空</span>
    <span class="na">beforeSend</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">// 成功请求后的回调</span>
    <span class="na">success</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">//错误回调</span>
    <span class="na">error</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">// 不管xhr成功还是失败，只有状态为complete就执行</span>
    <span class="na">complete</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">//在指定内容中执行回调</span>
    <span class="na">context</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="c1">//ajax触发事件为全局</span>
    <span class="na">global</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">// xhr</span>
    <span class="na">xhr</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="c1">//接受的数据类型</span>
    <span class="nx">accepts</span><span class="err">:</span> <span class="p">{</span>
      <span class="nl">script</span><span class="p">:</span> <span class="s1">'text/javascript, application/javascript, application/x-javascript'</span><span class="p">,</span>
      <span class="nx">json</span><span class="err">:</span>   <span class="nx">jsonType</span><span class="p">,</span>
      <span class="nx">xml</span><span class="err">:</span>    <span class="s1">'application/xml, text/xml'</span><span class="p">,</span>
      <span class="nx">html</span><span class="err">:</span>   <span class="nx">htmlType</span><span class="p">,</span>
      <span class="nx">text</span><span class="err">:</span>   <span class="s1">'text/plain'</span>
    <span class="p">},</span>
    <span class="c1">//是否跨域</span>
    <span class="nx">crossDomain</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="c1">//超时设置  默认不超时</span>
    <span class="nx">timeout</span><span class="err">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="c1">//数据需要被序列化</span>
    <span class="nx">processData</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">//对get请求数据进行缓存</span>
    <span class="nx">cache</span><span class="err">:</span> <span class="kc">true</span>
  <span class="p">}</span></code></pre></figure>

<blockquote>
  <p>序列化数据是对data参数进行的，因为大部分传进来的参数都是Object类型，而xhr接收参数的方式是字符串，所以必须把
Object对象转化成String每个参数用’&amp;’隔开,和get传参类似。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">a</span><span class="p">:</span><span class="s1">'0'</span> <span class="p">,</span> <span class="na">b</span><span class="p">:</span><span class="s1">'1'</span><span class="p">}</span>
    <span class="c1">//转换成</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="s1">'a=0&amp;b=1'</span></code></pre></figure>

<blockquote>
  <p>那么就有processData参数来设置data参数是否需要序列化。如果用户传人的类型已经是序列化的，那么就可以设置processData参数为false.
需要序列化的话就会调用$.param函数。
<img src="/blog/images/2015/1112_08.jpg" alt="$.param" /></p>
</blockquote>

<blockquote>
  <p>看起来可能有点不清楚，我把功能弱化一下。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="c1">//params.add 函数  </span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">key</span> <span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="err">等价于</span> <span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span><span class="s1">'='</span><span class="o">+</span> <span class="nx">value</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span> <span class="o">||</span> <span class="nx">value</span>
    <span class="cm">/**
	* 序列化
	* @param {Object} params [] 最后生成的参数数组
	* @param {Object} obj       需要序列化的对象
	* @param {Object} traditional  表示是否以传统的方式拼接数据
	* @param {Object} scope   表示范围
	*/</span>
	<span class="c1">//serialize弱化</span>
    <span class="nx">serialize</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">traditional</span> <span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">o</span> <span class="k">in</span> <span class="nx">obj</span> <span class="p">){</span>
	    <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span> <span class="p">){</span>
	    	<span class="nx">traditional</span> <span class="p">?</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">scope</span> <span class="p">:</span> <span class="nx">scope</span><span class="p">[]</span>
	    <span class="p">}</span>
	    <span class="c1">//3个分支,每次循环只会进入一个</span>
	    <span class="c1">//e.g : [{"name":"username","value":"foo"}]</span>
	    <span class="mi">1</span><span class="p">.</span> <span class="o">!</span><span class="nx">scope</span> <span class="o">&amp;&amp;</span> <span class="nx">array</span> <span class="o">&amp;&amp;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">o</span><span class="p">].</span><span class="nx">name</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">o</span><span class="p">].</span><span class="nx">value</span><span class="p">)</span>
	    <span class="c1">//obj[o] == array || obj[o] == object &amp;&amp; traditional</span>
	    <span class="c1">//递归序列化</span>
	    <span class="mi">2</span><span class="p">.</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">o</span><span class="p">],</span> <span class="nx">traditional</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span>
	    <span class="c1">//直接添加</span>
	    <span class="mi">3</span><span class="p">.</span> <span class="nx">params</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">o</span><span class="p">])</span>
	<span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<blockquote>
  <p>最后params得到的是一个数组，里面的每一项都是以’a=b’的形式储存的。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="c1">//e.g : $.param({a:1,b:{c:0,d:22},d:[1,2,3] , e:[{name:'username',value:'jin'}]})</span>
    <span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"a=1"</span><span class="p">,</span><span class="s2">"b[c]=0"</span><span class="p">,</span><span class="s2">"b[d]=22"</span><span class="p">,</span><span class="s2">"d[]=1"</span><span class="p">,</span><span class="s2">"d[]=2"</span><span class="p">,</span><span class="s2">"d[]=3"</span><span class="p">,</span><span class="s2">"e[0][name]=username"</span><span class="p">,</span><span class="s2">"e[0][value]=jin"</span><span class="p">]</span>
    <span class="c1">//通过'&amp;'将数组连接成字符串,改空格为'+'</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%20/g</span><span class="p">,</span> <span class="s1">'+'</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="s2">"a=1&amp;b%5Bc%5D=0&amp;b%5Bd%5D=22&amp;d%5B%5D=1&amp;d%5B%5D=2&amp;d%5B%5D=3&amp;e%5B0%5D%5Bname%5D=username&amp;e%5B0%5D%5Bvalue%5D=jin"</span></code></pre></figure>

<blockquote>
  <p>数据是序列化了，可是get和post的传送数据的方式是不一样的，所以必须在序列化外层在套上一层判断，
如果是get那么就将参数添加到url上，post是将数据通过xhr.send(data,null)传过去的。
<img src="/blog/images/2015/1112_09.jpg" alt="$.param" /></p>
</blockquote>

<blockquote>
  <p>appendQuery 函数 ——即 将数据添加到url。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="kd">function</span> <span class="nx">appendQuery</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">query</span> <span class="o">==</span> <span class="s1">''</span><span class="p">)</span> <span class="k">return</span> <span class="nx">url</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">'&amp;'</span> <span class="o">+</span> <span class="nx">query</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;?</span><span class="se">]{1,2}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">//可能看不明白的就是最后的正则</span>
    <span class="c1">// ? == ?</span>
    <span class="s1">'url?a=b&amp;c=d'</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;?</span><span class="se">]{1,2}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span> <span class="c1">//"url?a=b&amp;c=d"</span>
    <span class="c1">// ?&amp; = ?</span>
    <span class="s1">'url?&amp;a=b&amp;c=d'</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;?</span><span class="se">]{1,2}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span><span class="c1">//"url?a=b&amp;c=d"</span>
    <span class="c1">// &amp;? = ?</span>
    <span class="s1">'url&amp;?a=b&amp;c=d'</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;?</span><span class="se">]{1,2}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span><span class="c1">//"url?a=b&amp;c=d"</span>
    <span class="c1">// &amp;?&amp; = ?&amp;</span>
    <span class="s1">'url&amp;?&amp;a=b&amp;c=d'</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;?</span><span class="se">]{1,2}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span><span class="c1">//"url?&amp;a=b&amp;c=d"</span>
    <span class="c1">// &amp;&amp; = ?</span>
    <span class="s1">'url&amp;&amp;a=b&amp;c=d'</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;?</span><span class="se">]{1,2}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span><span class="c1">//"url?a=b&amp;c=d"</span>
    <span class="c1">// ?? = ?</span>
    <span class="s1">'url??a=b&amp;c=d'</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;?</span><span class="se">]{1,2}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span><span class="c1">//"url?a=b&amp;c=d"</span></code></pre></figure>

<blockquote>
  <p>现在就可以看出 replace(/[&amp;?]{1,2}/, ‘?’)这个正则就是对 ? , ?? , &amp; , &amp;&amp; , ?&amp; , &amp;? 的匹配，并转换为 ?。</p>
</blockquote>

<blockquote>
  <p>后续的问题就是将参数设置完全即可，没什么大的问题。不过要注意。post请求必须添加</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="c1">//内容类型  </span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">||</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">'GET'</span><span class="p">))</span> <span class="c1">//不是get请求则添加请求头</span>
      <span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">||</span> <span class="s1">'application/x-www-form-urlencoded'</span><span class="p">)</span><span class="c1">//post必须添加</span></code></pre></figure>

<blockquote>
  <p>你可能发现我是不是不想说了，是的。因为后面的参数设置没有多大问题了。看代码就能懂。
不过我要说另外的一样东西jsonp</p>
</blockquote>

<blockquote>
  <h4 id="jsonp">JSONP</h4>
  <p>举个例子</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="kd">var</span> <span class="nx">jp</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">)</span>
    <span class="nx">jp</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="o">+</span><span class="s1">'&amp;jsonp=callback'</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">jp</span><span class="p">)</span>
    <span class="kd">function</span> <span class="nx">callback</span><span class="p">(</span> <span class="nx">res</span> <span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
    <span class="p">}</span></code></pre></figure>

<blockquote>
  <p>这就是jsonp,这是个简单的例子。jsonp其实就是用script标签去请求服务器，jsonp是服务器接收的参数，callback是你定义的回调函数。
不是什么数据都是可以通过jsonp获取到，因为服务器不一定都获取了jsonp参数，不一定执行了 callback.</p>
</blockquote>

<blockquote>
  <p>服务器怎么写才能返回数据呢。</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">data</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="na">code</span><span class="p">:</span><span class="s1">'success'</span><span class="p">},</span>
        <span class="nx">func</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s1">'jsonp'</span><span class="p">]</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">func</span><span class="o">+</span><span class="s1">'('</span><span class="o">+</span><span class="nx">data</span><span class="o">+</span><span class="s1">')'</span><span class="p">)</span></code></pre></figure>

<blockquote>
  <p>下面来看看ajaxJSONP的源码
<img src="/blog/images/2015/1112_10.jpg" alt="$.ajaxJSONP" />
<img src="/blog/images/2015/1112_11.jpg" alt="$.ajaxJSONP" /></p>
</blockquote>

<blockquote>
  <p>最后给一张settings的参数表咯</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">//请求类型</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="c1">// 发送请求前执行的函数 , 默认 空</span>
    <span class="na">beforeSend</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">// 成功请求后的回调</span>
    <span class="na">success</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">//错误回调</span>
    <span class="na">error</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">// 不管xhr成功还是失败，只有状态为complete就执行</span>
    <span class="na">complete</span><span class="p">:</span> <span class="nx">empty</span><span class="p">,</span>
    <span class="c1">//在指定内容中执行回调</span>
    <span class="na">context</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="c1">//ajax触发事件为全局</span>
    <span class="na">global</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">// xhr</span>
    <span class="na">xhr</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="c1">//接受的数据类型</span>
    <span class="nx">accepts</span><span class="err">:</span> <span class="p">{</span>
      <span class="nl">script</span><span class="p">:</span> <span class="s1">'text/javascript, application/javascript, application/x-javascript'</span><span class="p">,</span>
      <span class="nx">json</span><span class="err">:</span>   <span class="nx">jsonType</span><span class="p">,</span>
      <span class="nx">xml</span><span class="err">:</span>    <span class="s1">'application/xml, text/xml'</span><span class="p">,</span>
      <span class="nx">html</span><span class="err">:</span>   <span class="nx">htmlType</span><span class="p">,</span>
      <span class="nx">text</span><span class="err">:</span>   <span class="s1">'text/plain'</span>
    <span class="p">},</span>
    <span class="c1">//是否跨域</span>
    <span class="nx">crossDomain</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="c1">//超时设置  默认不超时</span>
    <span class="nx">timeout</span><span class="err">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="c1">//数据需要被序列化</span>
    <span class="nx">processData</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">//对get请求数据进行缓存</span>
    <span class="nx">cache</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
    
    <span class="c1">//其他的</span>
    <span class="nx">context</span> <span class="c1">//内容</span>
    <span class="nx">dataType</span> <span class="c1">//数据类型</span>
    <span class="nx">jsonp</span> <span class="c1">//是不是jsonp请求</span>
    <span class="nx">mimeType</span> <span class="c1">//上传文件类型</span>
    <span class="nx">headers</span> <span class="c1">//请求头设置</span>
    <span class="nx">contentType</span> <span class="c1">//内容类型</span>
    <span class="nx">xhrFields</span> <span class="c1">//它可以添加到原生xhr对象上的key/value对</span>
    <span class="nx">async</span> <span class="c1">//请求是否异步</span>
    <span class="nx">username</span> <span class="c1">//http 1.1</span>
    <span class="nx">password</span> 
    <span class="nx">traditional</span> <span class="c1">//解析数据是否以传统方式</span>
  <span class="p">}</span></code></pre></figure>

<blockquote>
  <p>可能你还是有问题，比如Deferred函数.这个我自己现在还没有去研究，自己也值知道他大概的运作方式。如果要在ajax中使用它。
我到可以举个例子</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js">	<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span><span class="s2">"post"</span><span class="p">,</span><span class="c1">//get</span>
        <span class="na">url</span><span class="p">:</span><span class="s2">"/ajax"</span><span class="p">,</span>
        <span class="na">async</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
        <span class="na">data</span> <span class="p">:</span> <span class="p">{</span><span class="na">ajax</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
	<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'success'</span><span class="p">)</span>
	<span class="p">},</span><span class="kd">function</span><span class="p">(){</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span>
	<span class="p">})</span></code></pre></figure>

</div>
						</div>
				</div>
			</div>
			<div class="j-col-xs-12 j-col-sm-12 j-col-md-3">
	<div class="j-user">
		<div class="j-user-thumb">
			<a href=""><img src="/blog/images/user.jpg" alt="" /></a>
		</div>
		<div class="j-user-info">
			<a href="">微信</a>
			<a href="">微博</a>
			<a href="">QQ</a>
		</div>
	</div>
	<div class="j-class-list">
		<h3 class="j-row">分类</h3>
		
		<a href="/blog/category.html?category=笔记">笔记 <span class="j-class-i-num">(7)</span></a>
		
		<a href="/blog/category.html?category=JavaScript">JavaScript <span class="j-class-i-num">(7)</span></a>
		
		<a href="/blog/category.html?category=bee.js">bee.js <span class="j-class-i-num">(1)</span></a>
		
	</div>
</div>
		</div>
	</div>
	<div class="j-container-fluid j-footer">
	<div class="j-container">
		<p class="j-footer-say">喜欢一个人需要理由吗？需要吗？不需要吗？需要吗？……</p>
		<p class="j-footer-say j-tlgr">——周星驰 《大话西游》</p>
	</div>
</div>

</body>
</html>